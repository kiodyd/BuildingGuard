{"version":3,"sources":["blockMaker.js"],"names":["mvs","require","stateSystem","cc","Class","extends","Component","properties","blocks","default","type","Prefab","start","isPlay","index","nextIndex","Math","floor","random","length","needUp","currentBlock","lastIndex","needList","Game","BlockManager","sendUpdateBMsg","GameManager","gameState","GameState","Play","engine","sendFrameEvent","JSON","stringify","action","GLB","UPDATE_B","Index","NextIndex","setNeedUp","setIndex","checkNeed","id","includes","push","count","GameEnv","players","outPlayers","playerFsm","state","oneToPlayerFive","oneToPlayerFour","oneToPlayerThree","oneToPlayerTwo","twoToPlayerEnd","twoToPlayerFive","twoToPlayerFour","twoToPlayerThree","threeToPlayerEnd","threeToPlayerFive","threeToPlayerFour","fourToPlayerEnd","fourToPlayerFive","fiveToPlayerEnd","makeBlock","clientEvent","dispatch","eventType","playerRound","showNext","nodeDict","children","forEach","child","active","node","instantiate","parent","y","x","assistBar","getChildByName","getComponent","startAssist"],"mappings":"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","file":"blockMaker.js","sourceRoot":"..\\..\\..\\..\\assets\\scripts","sourcesContent":["var mvs = require(\"Matchvs\");\r\nvar stateSystem = require(\"StateSystem\");\r\n//生成方块\r\ncc.Class({\r\n    extends: cc.Component,\r\n\r\n    properties: {\r\n        blocks:{\r\n            default:[],\r\n            type:cc.Prefab,\r\n        },\r\n\r\n    },\r\n\r\n    // LIFE-CYCLE CALLBACKS:\r\n\r\n    // onLoad () {},\r\n\r\n    start () {\r\n        this.isPlay=false;//是否开始下落\r\n\r\n        this.index = 0;\r\n        this.nextIndex = Math.floor(Math.random() * this.blocks.length);\r\n        this.needUp = false;//是否需要增加方块\r\n        this.currentBlock = null;//当前下落方块\r\n        this.lastIndex = 0;//用于避免重复出现相同的方块\r\n\r\n        this.needList=[];//等待更新方块的玩家\r\n        Game.BlockManager = this;\r\n        \r\n        \r\n    },\r\n\r\n\r\n    sendUpdateBMsg: function () {\r\n        var index;\r\n        while (true) {\r\n            index = Math.floor(Math.random() * this.blocks.length);\r\n            if (index != this.lastIndex) {\r\n                this.lastIndex = index;\r\n                break;\r\n            }\r\n        }\r\n\r\n        this.index = this.nextIndex;\r\n        this.nextIndex = index;\r\n\r\n        if (Game.GameManager.gameState === GameState.Play) {\r\n            mvs.engine.sendFrameEvent(JSON.stringify({\r\n                action: GLB.UPDATE_B,\r\n                Index: this.index,\r\n                NextIndex:this.nextIndex\r\n            }));\r\n        }\r\n    },\r\n\r\n    setNeedUp() {\r\n        this.needUp = true;\r\n    },\r\n    setIndex(Index,NextIndex){\r\n        this.index = Index;\r\n        this.nextIndex = NextIndex;\r\n    },\r\n//检查是不是所有玩家都落地了\r\n    checkNeed(id){\r\n        if(!this.needList.includes(id)){\r\n            this.needList.push(id);\r\n        }\r\n\r\n        var count  = Game.GameEnv.players.length - Game.GameEnv.outPlayers.length;\r\n        if(this.needList.length == count){\r\n            if(stateSystem.playerFsm.state == \"state_player_one\"){\r\n                if(Game.GameEnv.outPlayers.includes(\"p2\")){\r\n                    if(Game.GameEnv.outPlayers.includes(\"p3\")){\r\n                        if(Game.GameEnv.outPlayers.includes(\"p4\")){\r\n                            stateSystem.playerFsm.oneToPlayerFive();\r\n                        }else{\r\n\r\n                            stateSystem.playerFsm.oneToPlayerFour();\r\n                        }\r\n                    }else{\r\n\r\n                        stateSystem.playerFsm.oneToPlayerThree();\r\n                    }\r\n                }else{\r\n\r\n                    stateSystem.playerFsm.oneToPlayerTwo();\r\n                }\r\n\r\n                \r\n            }else if(stateSystem.playerFsm.state == \"state_player_two\"){\r\n\r\n                if(Game.GameEnv.outPlayers.includes(\"p3\")){\r\n                    if(Game.GameEnv.outPlayers.includes(\"p4\")){\r\n                        if(Game.GameEnv.outPlayers.includes(\"p5\")){\r\n                            stateSystem.playerFsm.twoToPlayerEnd();\r\n                        }else{\r\n\r\n                            stateSystem.playerFsm.twoToPlayerFive();\r\n                        }\r\n                    }else{\r\n\r\n                        stateSystem.playerFsm.twoToPlayerFour();\r\n                    }\r\n                }else{\r\n\r\n                    stateSystem.playerFsm.twoToPlayerThree();\r\n                }\r\n\r\n\r\n            }else if(stateSystem.playerFsm.state == \"state_player_three\"){\r\n\r\n                if(Game.GameEnv.outPlayers.includes(\"p4\")){\r\n                    if(Game.GameEnv.outPlayers.includes(\"p5\")){\r\n                        stateSystem.playerFsm.threeToPlayerEnd();\r\n                    }else{\r\n\r\n                        stateSystem.playerFsm.threeToPlayerFive();\r\n                    }\r\n                }else{\r\n\r\n                    stateSystem.playerFsm.threeToPlayerFour();\r\n                }\r\n                \r\n            }else if(stateSystem.playerFsm.state == \"state_player_four\"){\r\n                \r\n\r\n                if(Game.GameEnv.outPlayers.includes(\"p5\")){\r\n                    stateSystem.playerFsm.fourToPlayerEnd();\r\n                }else{\r\n\r\n                    stateSystem.playerFsm.fourToPlayerFive();\r\n                }\r\n            }else if(stateSystem.playerFsm.state == \"state_player_five\"){\r\n                stateSystem.playerFsm.fiveToPlayerEnd();\r\n            }\r\n\r\n            this.needList = [];\r\n        }\r\n    },\r\n\r\n\r\n    // update (dt) {\r\n    //     if(this.isPlay){\r\n    //         if(!this.currentBlock){\r\n    //             if(GLB.isRoomOwner && !this.needUpCD){\r\n    //                 this.sendUpdateBMsg();\r\n    //                 this.needUpCD = true;\r\n    //                 setTimeout(function () {\r\n    //                     this.needUpCD = false;\r\n    //                 }.bind(this), 500);\r\n    //             }\r\n    //         }else{\r\n    //             let block = this.currentBlock.getComponent(\"block\");\r\n    //             if (!block.getInputEnabled() && GLB.isRoomOwner && !this.needUpCD) {\r\n    //                 this.sendUpdateBMsg();\r\n    //                 this.needUpCD = true;\r\n    //                 setTimeout(function () {\r\n    //                     this.needUpCD = false;\r\n    //                 }.bind(this), 500);\r\n    //             }\r\n                \r\n    //         }\r\n    //     }\r\n    // },\r\n    makeBlock() {\r\n        if (this.needUp) {\r\n            clientEvent.dispatch(clientEvent.eventType.playerRound);\r\n\r\n            var showNext = Game.GameEnv.nodeDict[\"Preview\"];\r\n            showNext.children.forEach(child => {\r\n                child.active = false;\r\n            });\r\n            showNext.children[this.nextIndex].active = true;\r\n\r\n            var node = cc.instantiate(this.blocks[this.index]);\r\n            this.currentBlock = node;\r\n            node.parent = this.node;\r\n            //todo  改为动态调整\r\n            node.y = 400;\r\n            node.x = 0;\r\n            this.needUp = false;\r\n\r\n            //开启辅助条\r\n            let assistBar = this.node.getChildByName(\"key_assistBar\");\r\n            assistBar.active = true;\r\n            assistBar.getComponent(\"assistBar\").startAssist();\r\n        }\r\n    }\r\n});\r\n"]}